using System;
using System.Text;
using SharpCpp;

namespace SharpCpp
{
    public abstract class UnitCompiler
    {
        // To hide YSyntaxWalker's functions from descedants of UnitWalker.
        class YSyntaxWalkerAdapter : YSyntaxWalker
        {
            UnitWalker _w;

            public YSyntaxWalkerAdapter(UnitWalker walker)
            {
                _w = walker;
            }

            #region YSyntaxWalker overrides

            protected override void Visit(YNamespace @namespace)
            {
                // Simplified guard: no nesting supported, no optimized.
                if (_w.Class.ChildOf(@namespace)) {
                    _w.Visit(_w._builder, @namespace);
                }
            }

            protected override void Visit(YClass @class)
            {
                if (_w.Class == @class) {
                    _w.Visit(_w._builder, @class);
                }
            }

            protected override void Visit(YField @field)
            {
                if (_w.Class.ParentOf(field)) {
                    _w.Visit(_w._builder, @field);
                }
            }

            protected override void Visit(YMethod @method)
            {
                if (_w.Class.ParentOf(method)) {
                    _w.Visit(_w._builder, @method);
                }
            }

            protected override void OnPreWalk()
            {
                base.OnPreWalk();

                _w._builder.Clear();
                _w._builder.Append("// Generated by SharpCpp\n\n");
                _w.InitBuilder(_w._builder);
            }

            protected override void OnPostWalk()
            {
                base.OnPostWalk();

                _w.FinalizeBuilder(_w._builder);
            }

            #endregion
        }

        public class UnitWalker
        {
            protected const string PublicMark = "{{public}}";

            protected const string PrivateMark = "{{private}}";

            protected const string IncludesMark = "{{includes}}";

            internal readonly StringBuilder _builder = new StringBuilder();

            internal protected YClass Class;

            protected UnitWalker(YClass @class)
            {
                Class = @class;
            }

            internal protected virtual void InitBuilder(StringBuilder builder) { }

            internal protected virtual void Visit(StringBuilder builder, YNamespace @namespace) { }

            internal protected virtual void Visit(StringBuilder builder, YClass @class) { }

            internal protected virtual void Visit(StringBuilder builder, YField @field) { }

            internal protected virtual void Visit(StringBuilder builder, YMethod @method) { }

            internal protected virtual void FinalizeBuilder(StringBuilder builder) { }

            internal string GeneratedText()
            {
                return _builder.ToString();
            }
        }

        public string Compile(YRoot root, GenerationUnit unit)
        {
            var walker = CreateUnitWalker(unit.Class);
            var walkerAdapter = new YSyntaxWalkerAdapter(walker);

            walkerAdapter.Walk(root);

            return walker.GeneratedText();
        }

        public abstract UnitWalker CreateUnitWalker(YClass @class);
    }
}
